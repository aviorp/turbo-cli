# syntax=docker/dockerfile:1
# Generated by  turbo-cli {{.Timestamp}}

FROM node:lts-alpine AS base
FROM base AS builder

WORKDIR /app
RUN npm i -g npm@latest
RUN npm i -g turbo


COPY . .
RUN turbo prune @papito/{{.Name}} --docker

FROM base AS installer


WORKDIR /app

COPY .gitignore .gitignore
COPY --from=builder /app/out/json/ .
COPY --from=builder /app/out/pnpm-lock.yaml ./pnpm-lock.yaml


RUN npm install pnpm@latest -g
RUN pnpm install --frozen-lockfile
# RUN pnpm install -g tsx

# Build the project and its dependencies
COPY --from=builder /app/out/full/ .
COPY turbo.json ./packages/typescript-config/tsconfig.json ./

FROM base AS runner
WORKDIR /app


COPY --from=installer /app .



EXPOSE 3300

WORKDIR /app/packages/db
RUN npx prisma format && npx prisma generate --sql

WORKDIR /app/apps/{{.Name}}

CMD ["npm" ,"run", "start"]
